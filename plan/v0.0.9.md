# VSCode Semantic Search Extension - v0.0.9

## Focus: DuckDB Schema Redesign & Tree View Integration

Improve database schema with proper hierarchical structure and add tree view to browse indexed content.

## Goals

- **Simplified schema design**: Derive folder hierarchy from file paths (no separate folders table)
- **Schema documentation**: Complete documentation of table structures and relationships
- **Tree view navigation**: Browse indexed workspaces, folders, files, and code chunks in sidebar

---

## Implementation

### 1. DuckDB Schema Redesign

#### Design Decision: Derived Folder Hierarchy

Instead of maintaining a separate `folders` table, we derive folder structure from file paths:

**Benefits:**
- Simpler maintenance - no need to create/delete folder records
- Natural fit for file watching - file events already have full paths
- Tree view is just a presentation concern - build it from grouped paths
- Matches VS Code's model - VS Code works with file URIs, not folder entities
- Fewer JOINs for common operations
- No folder count maintenance needed

#### New Table Structure

**`workspaces`** - Top-level workspace tracking
```sql
CREATE TABLE workspaces (
    workspace_id VARCHAR PRIMARY KEY,     -- UUID
    workspace_path VARCHAR NOT NULL,      -- Absolute path
    workspace_name VARCHAR,               -- Display name
    status VARCHAR DEFAULT 'active',      -- 'active' | 'indexing' | 'error'
    created_at BIGINT NOT NULL,
    last_updated_at BIGINT NOT NULL,
    total_files INTEGER DEFAULT 0,
    total_chunks INTEGER DEFAULT 0
);
CREATE UNIQUE INDEX idx_workspace_path ON workspaces(workspace_path);
```

**`indexed_files`** - File metadata with derived folder path
```sql
CREATE TABLE indexed_files (
    file_id VARCHAR PRIMARY KEY,          -- UUID
    workspace_id VARCHAR NOT NULL,
    file_path VARCHAR NOT NULL,           -- Full relative path, e.g., 'src/components/Button.tsx'
    folder_path VARCHAR NOT NULL,         -- Derived: 'src/components' (for grouping/tree view)
    file_name VARCHAR NOT NULL,           -- Just 'Button.tsx'
    md5_hash VARCHAR NOT NULL,
    language VARCHAR,
    file_size BIGINT,
    line_count INTEGER,
    chunk_count INTEGER DEFAULT 0,
    created_at BIGINT NOT NULL,
    last_indexed_at BIGINT NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(workspace_id) ON DELETE CASCADE
);
CREATE INDEX idx_file_workspace ON indexed_files(workspace_id);
CREATE INDEX idx_file_folder ON indexed_files(workspace_id, folder_path);
CREATE UNIQUE INDEX idx_file_path ON indexed_files(workspace_id, file_path);
```

**`code_chunks`** - Vector embeddings
```sql
CREATE TABLE code_chunks (
    chunk_id VARCHAR PRIMARY KEY,         -- UUID
    file_id VARCHAR NOT NULL,
    content TEXT NOT NULL,
    line_start INTEGER NOT NULL,
    line_end INTEGER NOT NULL,
    chunk_index INTEGER NOT NULL,         -- Order within file
    embedding FLOAT[768],                 -- Vector dimension (768 for most models)
    created_at BIGINT NOT NULL,
    FOREIGN KEY (file_id) REFERENCES indexed_files(file_id) ON DELETE CASCADE
);
CREATE INDEX idx_chunk_file ON code_chunks(file_id);
CREATE INDEX idx_chunk_embedding ON code_chunks USING HNSW(embedding) WITH (metric = 'cosine');
```

**`schema_migrations`** - Track schema versions
```sql
CREATE TABLE schema_migrations (
    version INTEGER PRIMARY KEY,
    applied_at BIGINT NOT NULL,
    description VARCHAR
);
```

#### Example Queries for Tree View

**Get folder hierarchy with file counts:**
```sql
SELECT 
    folder_path,
    COUNT(*) as file_count,
    SUM(chunk_count) as total_chunks
FROM indexed_files
WHERE workspace_id = ?
GROUP BY folder_path
ORDER BY folder_path;
```

**Get files in a specific folder:**
```sql
SELECT file_id, file_name, chunk_count, last_indexed_at
FROM indexed_files
WHERE workspace_id = ? AND folder_path = ?
ORDER BY file_name;
```

#### Migration Strategy

- Add schema version table to track migrations
- Implement migration from v1 (current flat schema) to v2 (hierarchical)
- Preserve existing data during migration
- Add rollback capability

### 2. Schema Documentation

Create `doc/duckdb-schema.md`:

- Complete table definitions with column descriptions
- Relationship diagrams (workspace ‚Üí folders ‚Üí files ‚Üí chunks)
- Indexes and their purposes
- Query patterns and best practices
- Example queries for common operations
- Schema version history

### 3. Tree View Integration

#### New View: Index Browser

**Location**: Add to sidebar next to search view

**Tree Structure**:
```
üìÅ Workspaces
  ‚îî‚îÄ üìÇ my-project (C:\Users\...\my-project)
      ‚îú‚îÄ üìÅ src (5 files, 234 chunks)
      ‚îÇ   ‚îú‚îÄ üìÅ components (3 files, 145 chunks)
      ‚îÇ   ‚îÇ   ‚îú‚îÄ üìÑ Button.tsx (23 chunks)
      ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ üìù Lines 1-50 (chunk 1)
      ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ üìù Lines 51-100 (chunk 2)
      ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ ...
      ‚îÇ   ‚îÇ   ‚îî‚îÄ üìÑ Input.tsx (18 chunks)
      ‚îÇ   ‚îî‚îÄ üìÑ index.ts (12 chunks)
      ‚îî‚îÄ üìÅ test (2 files, 89 chunks)
```

**Features**:
- Expand/collapse workspace, folders, files
- Show chunk counts at each level
- Click file to open in editor
- Click chunk to jump to specific line range
- Context menu actions:
  - Reindex file/folder/workspace
  - Remove from index
  - Copy path
  - Reveal in explorer

**Implementation**:
- Create `src/views/indexTreeView.ts`
- Implement `TreeDataProvider` interface
- Add refresh command
- Query DuckDB for hierarchical data
- Cache tree structure for performance

### 4. Update Services

**`vectorDbService.ts`**:
- Add methods for workspace/folder/file CRUD operations
- Implement hierarchical queries
- Update existing methods to use new schema
- Add migration logic

**New `migrationService.ts`**:
- Detect schema version
- Run migrations sequentially
- Validate data integrity after migration

---

## Testing

- Test migration from v0.0.8 schema to v0.0.9
- Verify tree view performance with large workspaces (1000+ files)
- Test cascade deletes (workspace ‚Üí folders ‚Üí files ‚Üí chunks)
- Validate foreign key constraints

---

## Documentation Updates

- Update README with tree view screenshots
- Add schema documentation to `doc/duckdb-schema.md`
- Update CHANGELOG with breaking changes note
- Document migration process for users

---

## Timeline Estimate

- Schema redesign & migration: 2-3 days
- Schema documentation: 1 day
- Tree view implementation: 2-3 days
- Testing & polish: 1 day

**Total**: ~1 week
